

===============================================================================

Ensure you have defined root_url to *something* in your config/routes.rb.
     For example:

       root to: "home#index"

1. Ensure you have defined default url options in your environments files. Here
   is an example of default_url_options appropriate for a development environment
   in config/environments/development.rb:

     config.action_mailer.default_url_options = { host: 'localhost', port: 3000 }
      
   In production, :host should be set to the actual host of your application.

2. Add the following lines in app/views/layouts/application.html.erb.

    <%= render partial: "auth_m/layouts/nav_bar"%>

3. Add the following lines in app/controllers/application_controller.rb:

    before_action :authenticate_user!

    protect_from_forgery with: :exception  

    helper_method :current_management, :user_signed_in?

    rescue_from ActionController::InvalidAuthenticityToken do |exception|   
      redirect_to auth_m.new_user_session_path, alert: "Invalid Authenticity Token"
    end 

    rescue_from CanCan::AccessDenied do |exception|    
      redirect_to main_app.root_path, alert: exception.message  
    end

    def after_sign_in_path_for(resource)
      set_sesssion_management
      main_app.root_path
    end

    def after_sign_out_path_for(resource)
      main_app.root_path
    end
    
    def current_ability
      @current_ability ||= AuthM::Ability.new(current_user)
    end

    def current_management
      AuthM::Management.find(session[:management_id]) unless session[:management_id].nil?
    end 

    def set_current_management(id)
      session[:management_id] = id 
    end

    impersonates :user

    private 

      def set_sesssion_management 
        session[:management_id] = AuthM::Management.first.id if current_user.has_role? :root
        session[:management_id] = current_user.management.id if (current_user.has_role? :admin) || (current_user.has_role? :user)
        session[:management_id] = nil if current_user.has_role? :public
      end  

4. Add the following lines in app/config/secrets.yml:

    FACEBOOK_KEY: -- key --
    FACEBOOK_SECRET: -- key --

    GOOGLE_KEY: -- key --
    GOOGLE_SECRET: -- key --

    TWITTER_KEY: -- key --
    TWITTER_SECRET: -- key --

    RECAPTCHA_SITE_KEY: -- key -- 
    RECAPTCHA_SECRET_KEY: -- key --
        
===============================================================================


